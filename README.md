# Gristips

Gristips est une plateforme d'automatisation pour vos documents Grist, r√©serv√©e aux agents publics de l'administration fran√ßaise. L'application permet de cr√©er des automatisations avanc√©es comme la synchronisation p√©riodique entre documents, la copie automatique de tables selon des r√®gles personnalis√©es, et la gestion de workflows complexes.

## üöÄ Fonctionnalit√©s

### ‚úÖ Impl√©ment√©es

- **Authentification ProConnect** : Connexion s√©curis√©e via le service d'authentification de l'√âtat fran√ßais
- **Interface DSFR** : Interface utilisateur conforme au Syst√®me de Design de l'√âtat fran√ßais
- **Gestion des agents publics** : V√©rification automatique du statut d'agent public via ProConnect
- **Dashboard d'administration** : Interface de gestion pour les agents publics authentifi√©s
- **Gestion de sessions avanc√©e** : Sessions s√©curis√©es avec timeout automatique et renouvellement
- **Validation de configuration** : V√©rification automatique de la configuration ProConnect
- **Middleware de s√©curit√©** : Protection automatique des routes selon le statut utilisateur
- **Gestion d'erreurs** : Syst√®me d'erreurs structur√© avec logging et pages d√©di√©es
- **Tests complets** : Suite de tests unitaires, composants et int√©gration

### üîÑ √Ä venir

- **Automatisations Grist** : Outils d'automatisation pour vos documents Grist
- **Workflows personnalis√©s** : Configuration de workflows complexes avec conditions
- **Int√©grations API** : Connexions avec d'autres services gouvernementaux
- **Tableau de bord avanc√©** : Statistiques et monitoring des automatisations

## üõ† Stack Technique

### Frontend

- **Next.js 15.5.0** avec Pages Router (pas App Router)
- **React 19.1.0** et React DOM 19.1.0
- **TypeScript 5** pour le typage statique
- **@codegouvfr/react-dsfr 1.26.0** - Syst√®me de Design de l'√âtat fran√ßais
- **Emotion** (@emotion/react 11.14.0, @emotion/server 11.11.0, @emotion/styled 11.14.1) pour CSS-in-JS
- **tss-react 4.9.19** pour les styles TypeScript-safe
- **@mui/material 7.3.1** pour les composants additionnels

### Backend & Base de donn√©es

- **NextAuth.js 4.24.11** pour l'authentification
- **Prisma 6.14.0** comme ORM
- **PostgreSQL 15** comme base de donn√©es (via Docker)
- **@next-auth/prisma-adapter 1.0.7** pour l'int√©gration NextAuth/Prisma

### S√©curit√© & Authentification

- **jose 6.0.13** pour la v√©rification des tokens JWT ProConnect
- **jsonwebtoken 9.0.2** pour la manipulation des tokens JWT
- **ProConnect** comme provider d'authentification OAuth2/OpenID Connect

### Tests

- **Vitest 3.2.4** comme framework de test
- **@testing-library/react 16.3.0** pour les tests de composants
- **@testing-library/jest-dom 6.8.0** pour les matchers Jest
- **@testing-library/user-event 14.6.1** pour les interactions utilisateur
- **jsdom 26.1.0** comme environnement de test

## üìã Pr√©requis

- **Node.js** 18.0.0 ou sup√©rieur
- **npm**, **yarn**, **pnpm** ou **bun**
- **Docker** et **Docker Compose** (pour la base de donn√©es PostgreSQL)
- **Compte ProConnect** pour l'authentification (agents publics uniquement)

## ‚öôÔ∏è Configuration du build

### Next.js Configuration

Le projet utilise une configuration Next.js personnalis√©e (`next.config.ts`) :

```typescript
const nextConfig: NextConfig = {
  reactStrictMode: true, // Mode strict React activ√©
  webpack: (config) => {
    // Support des fichiers .woff2 pour DSFR
    config.module.rules.push({
      test: /\.woff2$/,
      type: "asset/resource",
    });
    return config;
  },
  // Transpilation des packages DSFR et tss-react
  transpilePackages: ["@codegouvfr/react-dsfr", "tss-react"],
};
```

### TypeScript Configuration

Configuration TypeScript (`tsconfig.json`) :

- **Target** : ES2017
- **Module** : ESNext avec bundler resolution
- **Strict mode** : Activ√©
- **Path mapping** : `@/*` vers `./src/*`
- **JSX** : preserve (g√©r√© par Next.js)

### ESLint Configuration

Configuration ESLint moderne (`eslint.config.mjs`) avec Flat Config :

```javascript
const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "build/**",
      "next-env.d.ts",
      "src/test/**",
      "**/*.test.ts",
      "**/*.test.tsx",
    ],
  },
];
```

- **Extensions** : `next/core-web-vitals`, `next/typescript`
- **Ignores** : Fichiers de build, tests, et fichiers g√©n√©r√©s
- **Compatibilit√©** : Support des configurations ESLint legacy via `@eslint/eslintrc`

### Configuration des Tests

Le projet utilise **Vitest** avec deux configurations :

**Configuration principale** (`vitest.config.ts`) :

- **Environnement** : jsdom pour les tests de composants React
- **Plugins** : @vitejs/plugin-react pour le support JSX
- **Setup** : `src/test/setup.ts` pour la configuration globale
- **Alias** : `@/*` vers `./src/*`

**Configuration tests unitaires** (`vitest.config.unit.ts`) :

- **Inclut** : Tests dans `src/test/lib/` et `src/test/integration/`
- **Exclut** : Tests de composants dans `src/test/pages/`

## üöÄ Installation et Configuration

### 1. Cloner le projet

```bash
git clone <repository-url>
cd gristips
```

### 2. Installer les d√©pendances

```bash
npm install
# ou
yarn install
# ou
pnpm install
```

### 3. Configuration de l'environnement

Copiez le fichier d'exemple et configurez vos variables d'environnement :

```bash
cp .env.example .env.local
```

√âditez `.env.local` avec vos vraies valeurs ProConnect :

```env
# ProConnect Configuration
PROCONNECT_CLIENT_ID=your_proconnect_client_id_here
PROCONNECT_CLIENT_SECRET=your_proconnect_client_secret_here
PROCONNECT_DOMAIN=fca.integ01.dev-agentconnect.fr
PROCONNECT_ISSUER=https://fca.integ01.dev-agentconnect.fr/api/v2

# NextAuth Configuration
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your_nextauth_secret_here

# Database Configuration
DATABASE_URL=postgresql://postgres:password@localhost:5433/gristips_dev
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
POSTGRES_DB=gristips_dev
```

> ‚ö†Ô∏è **Important** : Remplacez `your_proconnect_client_id_here` et `your_proconnect_client_secret_here` par vos vraies valeurs ProConnect obtenues sur le portail partenaires. Le domaine `fca.integ01.dev-agentconnect.fr` est configur√© pour l'environnement d'int√©gration avec l'issuer `/api/v2`.

### 4. Configuration ProConnect

Pour obtenir vos identifiants ProConnect :

1. **Inscription sur le portail partenaires**

   - Rendez-vous sur le [portail partenaires ProConnect](https://partenaires.proconnect.gouv.fr/)
   - Cr√©ez un compte avec votre adresse email professionnelle (.gouv.fr)

2. **Cr√©ation d'une application**

   - Cr√©ez une nouvelle application dans votre espace partenaire
   - Renseignez les informations de votre service

3. **Configuration des URLs de callback**

   - **D√©veloppement** : `http://localhost:3000/api/auth/callback/proconnect`
   - **Production** : `https://votre-domaine.gouv.fr/api/auth/callback/proconnect`

4. **R√©cup√©ration des identifiants**

   - Notez votre `CLIENT_ID` (format UUID)
   - Notez votre `CLIENT_SECRET` (cha√Æne s√©curis√©e)
   - Configurez l'environnement ProConnect :
     - **Int√©gration/D√©veloppement** : `https://fca.integ01.dev-agentconnect.fr/api/v2`
     - **Production** : `https://auth.agentconnect.gouv.fr/api/v2`

   > **Note** : Le fichier `.env.example` utilise l'environnement d'int√©gration par d√©faut avec le domaine `fca.integ01.dev-agentconnect.fr` et l'issuer `/api/v2`, adapt√© pour le d√©veloppement local.

5. **G√©n√©ration du secret NextAuth**
   ```bash
   # G√©n√©rer un secret s√©curis√©
   openssl rand -base64 32
   ```

### 5. D√©marrage de la base de donn√©es

Lancez PostgreSQL avec Docker Compose :

```bash
docker-compose up -d
```

V√©rifiez que PostgreSQL fonctionne :

```bash
docker-compose ps
```

**Configuration Docker** :

- **Image** : PostgreSQL 15
- **Port** : 5433 (pour √©viter les conflits avec PostgreSQL local sur le port 5432)
- **Base de donn√©es** : `gristips_dev`
- **Utilisateur** : `postgres` / `password`
- **Volume persistant** : `postgres_data` (les donn√©es survivent aux red√©marrages)

### 6. Configuration de la base de donn√©es

G√©n√©rez le client Prisma et ex√©cutez les migrations :

```bash
# G√©n√©rer le client Prisma
npx prisma generate

# Ex√©cuter les migrations
npx prisma migrate deploy

# (Optionnel) Visualiser la base de donn√©es
npx prisma studio
```

### 7. D√©marrage de l'application

```bash
# D√©veloppement
npm run dev

# Production
npm run build
npm run start
```

L'application sera accessible sur [http://localhost:3000](http://localhost:3000).

## üóÑ Structure de la base de donn√©es

La base de donn√©es utilise PostgreSQL 15 avec Prisma 6.14.0 comme ORM. Le sch√©ma est d√©fini dans `prisma/schema.prisma`.

### Tables principales

- **users** : Informations des utilisateurs

  - `id` (String, CUID) - Identifiant unique
  - `email` (String, unique) - Email de l'utilisateur
  - `name` (String) - Nom complet
  - `isPublicAgent` (Boolean) - Statut d'agent public (mapp√© vers `is_public_agent`)
  - `organization` (String, optionnel) - Organisation d'appartenance
  - `createdAt`, `updatedAt` - Timestamps (mapp√©s vers `created_at`, `updated_at`)

- **accounts** : Comptes li√©s aux providers d'authentification (ProConnect)

  - `id`, `userId` (mapp√© vers `user_id`), `type`, `provider`, `providerAccountId` (mapp√© vers `provider_account_id`)
  - `refresh_token`, `access_token`, `expires_at`
  - `token_type`, `scope`, `id_token`, `session_state`
  - `createdAt`, `updatedAt` - Timestamps (mapp√©s vers `created_at`, `updated_at`)

- **sessions** : Sessions utilisateur actives

  - `id`, `sessionToken` (mapp√© vers `session_token`, unique), `userId` (mapp√© vers `user_id`), `expires`
  - `createdAt`, `updatedAt` - Timestamps (mapp√©s vers `created_at`, `updated_at`)
  - Gestion automatique par NextAuth.js

- **verification_tokens** : Tokens de v√©rification
  - `identifier`, `token` (unique), `expires`
  - Mapp√© vers `verification_tokens`

### Configuration Docker

**PostgreSQL 15** via Docker Compose (`docker-compose.yml`) :

- **Image** : PostgreSQL 15
- **Port** : 5433 (pour √©viter les conflits avec PostgreSQL local sur le port 5432)
- **Base de donn√©es** : `gristips_dev`
- **Utilisateur** : `postgres` / `password`
- **Volume persistant** : `postgres_data` (les donn√©es survivent aux red√©marrages)
- **Restart policy** : `unless-stopped`

### Relations

- Un utilisateur peut avoir plusieurs comptes (accounts) et sessions
- Les comptes et sessions sont li√©s √† un utilisateur via `userId`
- Suppression en cascade : si un utilisateur est supprim√©, ses comptes et sessions le sont aussi
- Contraintes d'unicit√© : `[provider, providerAccountId]` pour les comptes, `sessionToken` pour les sessions

## üîß Scripts disponibles

```bash
# D√©veloppement
npm run dev          # D√©marre le serveur de d√©veloppement (met √† jour les ic√¥nes DSFR automatiquement)

# Production
npm run build        # Build l'application pour la production (met √† jour les ic√¥nes DSFR automatiquement)
npm run start        # D√©marre l'application en mode production

# Tests
npm run test         # Ex√©cute tous les tests (vitest --run)
npm run test:unit    # Ex√©cute uniquement les tests unitaires et d'int√©gration
npm run test:watch   # Ex√©cute les tests en mode watch (vitest)
npm run test:ui      # Interface graphique pour les tests (vitest --ui)
npm run test:coverage # G√©n√®re le rapport de couverture (vitest --coverage)

# Qualit√© de code
npm run lint         # V√©rifie le code avec ESLint

# Base de donn√©es
npx prisma generate     # G√©n√®re le client Prisma
npx prisma migrate dev  # Cr√©e et applique une nouvelle migration
npx prisma migrate deploy # Applique les migrations en production
npx prisma studio       # Interface graphique pour la base de donn√©es
npx prisma db push      # Synchronise le sch√©ma sans migration

# Docker
docker-compose up -d    # D√©marre PostgreSQL en arri√®re-plan
docker-compose ps       # V√©rifie le statut des conteneurs
docker-compose logs postgres # Affiche les logs PostgreSQL
docker-compose down     # Arr√™te et supprime les conteneurs
```

> **Note** : Les scripts `predev` et `prebuild` mettent automatiquement √† jour les ic√¥nes DSFR avant le d√©marrage du serveur de d√©veloppement ou la construction de l'application.

## üåç Environnements

### D√©veloppement

- **ProConnect** : Environnement d'int√©gration
  - Domain : `fca.integ01.dev-agentconnect.fr`
  - Issuer : `https://fca.integ01.dev-agentconnect.fr`
- **Base de donn√©es** : PostgreSQL 15 local via Docker (port 5433)
- **URL** : `http://localhost:3000`
- **Tests** : Vitest avec jsdom et @testing-library

### Production

- **ProConnect** : Environnement de production
  - Issuer : `https://auth.agentconnect.gouv.fr/api/v2`
- **Base de donn√©es** : PostgreSQL h√©berg√©
- **URL** : Votre domaine en `.gouv.fr`
- **HTTPS** : Obligatoire en production
- **S√©curit√©** : Cookies s√©curis√©s, validation JWT, middleware de protection

## üß™ Tests

Le projet utilise **Vitest 3.2.4** comme framework de test avec une configuration compl√®te pour les tests unitaires, de composants et d'int√©gration.

### Types de tests

- **Tests unitaires** : Fonctions utilitaires et services (`src/test/lib/`)

  - `auth.test.ts` : Tests des utilitaires d'authentification
  - `proconnect.test.ts` : Tests de l'int√©gration ProConnect

- **Tests de composants** : Pages et composants React (`src/test/pages/`)

  - `admin.test.tsx` : Tests de la page d'administration
  - `auth/signin.test.tsx` : Tests de la page de connexion
  - `auth/access-denied.test.tsx` : Tests de la page d'acc√®s refus√©

- **Tests d'int√©gration** : Flux complets d'authentification (`src/test/integration/`)
  - `auth-flow.test.ts` : Tests du flux d'authentification complet
  - `session-management.test.ts` : Tests de la gestion des sessions
  - `redirect-flow.test.ts` : Tests des redirections selon le statut utilisateur

### Configuration des tests

**Configuration principale** (`vitest.config.ts`) :

```typescript
export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: "jsdom",
    setupFiles: ["./src/test/setup.ts"],
  },
  resolve: {
    alias: { "@": path.resolve(__dirname, "./src") },
  },
  optimizeDeps: {
    include: ["@codegouvfr/react-dsfr"],
  },
  ssr: {
    noExternal: ["@codegouvfr/react-dsfr"],
  },
});
```

**Configuration tests unitaires** (`vitest.config.unit.ts`) :

```typescript
export default defineConfig({
  // ... configuration de base
  test: {
    include: ["src/test/lib/**/*.test.ts", "src/test/integration/**/*.test.ts"],
    exclude: ["src/test/pages/**/*.test.tsx"], // Exclut les tests de composants
  },
});
```

### Outils de test

- **@testing-library/react 16.3.0** : Tests de composants React
- **@testing-library/jest-dom 6.8.0** : Matchers Jest pour le DOM
- **@testing-library/user-event 14.6.1** : Simulation d'interactions utilisateur
- **jsdom 26.1.0** : Environnement DOM pour les tests

### Ex√©cution des tests

```bash
# Tests en une fois
npm run test

# Tests unitaires uniquement
npm run test:unit

# Tests en mode watch
npm run test:watch

# Interface graphique
npm run test:ui

# Couverture de code
npm run test:coverage
```

### Mocking et configuration

Les tests utilisent des mocks pour :

- **NextAuth.js** : Sessions et authentification
- **ProConnect** : R√©ponses API et claims
- **Composants DSFR** : Simplification pour les tests
- **Variables d'environnement** : Configuration de test isol√©e

Le fichier `src/test/setup.ts` configure l'environnement de test avec tous les mocks n√©cessaires.

## üîí S√©curit√©

### Authentification ProConnect

L'application utilise ProConnect (ex-AgentConnect) pour l'authentification :

- **OpenID Connect** avec v√©rification JWT via jose 6.0.13
- **Scopes requis** : `openid`, `given_name`, `usual_name`, `email`, `organizational_unit`, `belonging_population`
- **V√©rification du statut d'agent public** via le claim `belonging_population` (doit contenir "agent")
- **Validation des tokens** avec les cl√©s publiques JWKS de ProConnect

### Middleware de s√©curit√©

Le middleware Next.js (`middleware.ts`) prot√®ge automatiquement les routes :

```typescript
// Configuration des routes
const protectedRoutes = ["/admin"]; // Agents publics uniquement
const authRoutes = ["/auth/signin", "/auth/error", "/auth/access-denied"]; // Pages d'authentification
const publicRoutes = ["/", "/api/auth"]; // Acc√®s libre
```

**Fonctionnement** :

- **V√©rification JWT** : Validation du token de session avec `next-auth/jwt`
- **Redirection automatique** : `/auth/signin` si non authentifi√©
- **Contr√¥le d'acc√®s** : `/auth/access-denied` si non-agent public pour `/admin/*`
- **Gestion d'erreurs** : Redirection vers `/auth/error` en cas de probl√®me middleware
- **Routes exclues** : `/_next/*`, `/favicon.ico`, `/public/*`, `/api/auth/*`

**S√©curit√©** :

- V√©rification du statut `isPublicAgent` pour les routes administratives
- Pr√©servation de l'URL de destination via `callbackUrl`
- Gestion des erreurs avec logging s√©curis√©

### Configuration s√©curis√©e

- **HTTPS obligatoire** en production
- **Cookies s√©curis√©s** avec flags `httpOnly`, `secure`, et `sameSite`
- **Sessions JWT** avec expiration automatique (30 jours max, 2h d'inactivit√©)
- **Validation des variables d'environnement** au d√©marrage avec `config-validation.ts`
- **Gestion d'erreurs structur√©e** avec logging s√©curis√©

## üêõ D√©pannage

### Erreurs courantes

#### 1. Erreur de connexion √† la base de donn√©es

```
Error: P1001: Can't reach database server
```

**Solutions :**

- V√©rifiez que Docker est d√©marr√© : `docker-compose ps`
- Red√©marrez PostgreSQL : `docker-compose restart postgres`
- V√©rifiez la variable `DATABASE_URL` dans `.env.local`
- Assurez-vous que le port 5433 n'est pas utilis√© par un autre service

#### 2. Erreur ProConnect "Configuration"

```
Error: Variables d'environnement ProConnect manquantes
```

**Solutions :**

- V√©rifiez que `PROCONNECT_CLIENT_ID` et `PROCONNECT_CLIENT_SECRET` sont d√©finis dans `.env.local`
- Assurez-vous que `NEXTAUTH_SECRET` est configur√© (g√©n√©rez-en un avec `openssl rand -base64 32`)
- V√©rifiez que `PROCONNECT_ISSUER` correspond √† votre environnement :
  - D√©veloppement/Int√©gration : `https://fca.integ01.dev-agentconnect.fr/api/v2`
  - Production : `https://auth.agentconnect.gouv.fr/api/v2`
- V√©rifiez que `PROCONNECT_DOMAIN` est configur√© (pour l'int√©gration : `fca.integ01.dev-agentconnect.fr`)
- V√©rifiez l'URL de callback dans votre configuration ProConnect
- Assurez-vous que vos identifiants ne contiennent pas les valeurs par d√©faut (`your_proconnect_client_id_here`)
- V√©rifiez que `PROCONNECT_ISSUER` inclut bien `/api/v2` √† la fin

#### 3. Erreur "Access Denied"

```
Acc√®s refus√© - Service r√©serv√© aux agents publics
```

**Solutions :**

- V√©rifiez que votre compte ProConnect indique bien votre statut d'agent public
- Contactez votre service RH ou informatique pour v√©rifier vos droits
- En d√©veloppement, v√©rifiez que vous utilisez le bon environnement ProConnect

#### 4. Erreur Prisma "Schema not found"

```
Error: Schema not found
```

**Solutions :**

- Ex√©cutez `npx prisma generate`
- Puis `npx prisma migrate deploy`
- Red√©marrez l'application

#### 5. Erreurs de build Next.js

```
Error: Module not found: Can't resolve '@codegouvfr/react-dsfr'
```

**Solutions :**

- V√©rifiez que toutes les d√©pendances sont install√©es : `npm install`
- Nettoyez le cache Next.js : `rm -rf .next`
- Red√©marrez le serveur de d√©veloppement : `npm run dev`

#### 6. Erreurs de tests

```
Error: Cannot assign to 'NODE_ENV' because it is a read-only property
```

**Solutions :**

- Les tests utilisent des mocks pour les variables d'environnement configur√©s dans `src/test/setup.ts`
- Red√©marrez les tests : `npm run test`
- V√©rifiez que jsdom est correctement install√© : `npm install jsdom --save-dev`
- Pour les tests unitaires uniquement : `npm run test:unit`
- Interface graphique des tests : `npm run test:ui`

#### 7. Erreurs de configuration DSFR

```
Error: Cannot resolve module '@codegouvfr/react-dsfr'
```

**Solutions :**

- V√©rifiez que les ic√¥nes DSFR sont √† jour : `npx react-dsfr update-icons`
- Les scripts `predev` et `prebuild` mettent automatiquement √† jour les ic√¥nes
- Nettoyez le cache : `rm -rf .next node_modules/.cache`
- R√©installez les d√©pendances : `npm ci`

### Logs et debugging

En d√©veloppement, consultez les logs :

```bash
# Logs de l'application Next.js
npm run dev

# Logs PostgreSQL
docker-compose logs postgres

# Logs des tests
npm run test:watch

# Interface de debug des tests
npm run test:ui
```

### Validation de la configuration

L'application inclut un syst√®me de validation automatique de la configuration au d√©marrage. Utilisez √©galement la page de v√©rification de configuration :

```
http://localhost:3000/admin/config-check
```

Cette page v√©rifie :

- **Variables d'environnement ProConnect** : CLIENT_ID, CLIENT_SECRET, DOMAIN, ISSUER
- **Configuration NextAuth.js** : NEXTAUTH_URL, NEXTAUTH_SECRET
- **Connexion √† la base de donn√©es** : DATABASE_URL et connectivit√© PostgreSQL
- **Endpoints ProConnect** : Accessibilit√© des services ProConnect (JWKS, etc.)
- **Scopes et claims** : Configuration des scopes OpenID Connect requis
- **S√©curit√©** : Validation des secrets et URLs selon l'environnement

**Fonctionnalit√©s de validation** :

- **Validation au d√©marrage** : V√©rification compl√®te lors du lancement de l'application
- **Validation runtime** : Contr√¥les lors des appels API critiques
- **Messages d'erreur d√©taill√©s** : Guidance pour r√©soudre les probl√®mes de configuration
- **Environnements multiples** : Support d√©veloppement, int√©gration et production
- **Connectivit√© ProConnect** : Test de la disponibilit√© des endpoints

La validation s'ex√©cute automatiquement au d√©marrage et affiche des erreurs d√©taill√©es si la configuration est incorrecte. En production, l'application refuse de d√©marrer avec une configuration invalide.

> **Note importante** : La configuration ProConnect a √©t√© mise √† jour pour utiliser le nouveau domaine d'int√©gration `fca.integ01.dev-agentconnect.fr` avec l'issuer `/api/v2`. Assurez-vous que votre fichier `.env.local` utilise les nouvelles variables `PROCONNECT_DOMAIN` et `PROCONNECT_ISSUER` comme indiqu√© dans `.env.example`.

## üìö Documentation

### Documentation du projet

- **[Guide de d√©ploiement](./DEPLOYMENT.md)** : Configuration et d√©ploiement en production avec ProConnect
- **[Sp√©cifications techniques](./.kiro/specs/proconnect-authentication/)** : Requirements, design et plan d'impl√©mentation

### Liens utiles

- [Documentation ProConnect](https://partenaires.proconnect.gouv.fr/documentation)
- [Syst√®me de Design de l'√âtat (DSFR)](https://www.systeme-de-design.gouv.fr/)
- [NextAuth.js Documentation](https://next-auth.js.org/)
- [Prisma Documentation](https://www.prisma.io/docs/)
- [Next.js Documentation](https://nextjs.org/docs)

### Architecture du projet

```
src/
‚îú‚îÄ‚îÄ components/          # Composants React r√©utilisables
‚îÇ   ‚îú‚îÄ‚îÄ ErrorBoundary.tsx
‚îÇ   ‚îî‚îÄ‚îÄ home/           # Composants de la page d'accueil
‚îÇ       ‚îú‚îÄ‚îÄ CTASection.tsx
‚îÇ       ‚îú‚îÄ‚îÄ FeaturesSection.tsx
‚îÇ       ‚îú‚îÄ‚îÄ HeroSection.tsx
‚îÇ       ‚îú‚îÄ‚îÄ HowItWorksSection.tsx
‚îÇ       ‚îú‚îÄ‚îÄ ProblemSection.tsx
‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ lib/                # Utilitaires et services
‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Modules d'authentification
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts   # Utilitaires c√¥t√© client
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts    # Exports principaux
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ proconnect.ts # Configuration ProConnect
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ server.ts   # Utilitaires c√¥t√© serveur
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.ts  # Gestion des sessions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts    # Types d'authentification
‚îÇ   ‚îú‚îÄ‚îÄ api/            # Utilitaires API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts   # Client API avec gestion d'erreurs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error-handling.ts # Gestion d'erreurs serveur
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts    # Exports API
‚îÇ   ‚îú‚îÄ‚îÄ validation/     # Validation de configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.ts   # Validation ProConnect
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts    # Exports validation
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts         # Utilitaires d'authentification legacy
‚îÇ   ‚îú‚îÄ‚îÄ proconnect.ts   # Int√©gration ProConnect legacy
‚îÇ   ‚îú‚îÄ‚îÄ config-validation.ts # Validation de configuration legacy
‚îÇ   ‚îú‚îÄ‚îÄ error-handling.ts    # Gestion d'erreurs legacy
‚îÇ   ‚îú‚îÄ‚îÄ useSessionManagement.ts # Hook de gestion de session
‚îÇ   ‚îú‚îÄ‚îÄ SessionTimeoutWarning.tsx # Composant d'avertissement
‚îÇ   ‚îú‚îÄ‚îÄ client-error-handling.ts # Gestion d'erreurs client
‚îÇ   ‚îî‚îÄ‚îÄ createEmotionCache.ts # Configuration Emotion
‚îú‚îÄ‚îÄ pages/              # Pages Next.js (Pages Router)
‚îÇ   ‚îú‚îÄ‚îÄ _app.tsx        # Configuration globale (DSFR, Emotion, Session)
‚îÇ   ‚îú‚îÄ‚îÄ _document.tsx   # Document HTML personnalis√©
‚îÇ   ‚îú‚îÄ‚îÄ index.tsx       # Page d'accueil
‚îÇ   ‚îú‚îÄ‚îÄ admin.tsx       # Dashboard admin
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config-check.tsx # Page de v√©rification config
‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Pages d'authentification
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ signin.tsx  # Page de connexion ProConnect
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error.tsx   # Page d'erreur d'authentification
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ access-denied.tsx # Page d'acc√®s refus√©
‚îÇ   ‚îî‚îÄ‚îÄ api/            # API Routes
‚îÇ       ‚îú‚îÄ‚îÄ auth/       # Endpoints NextAuth.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ [...nextauth].ts # Configuration NextAuth
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ secure-signout.ts # D√©connexion s√©curis√©e
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ validate-session.ts # Validation de session
‚îÇ       ‚îú‚îÄ‚îÄ health/     # Health checks
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ proconnect.ts # V√©rification ProConnect
‚îÇ       ‚îî‚îÄ‚îÄ hello.ts    # API exemple
‚îú‚îÄ‚îÄ styles/             # Styles CSS
‚îÇ   ‚îú‚îÄ‚îÄ globals.css     # Styles globaux
‚îÇ   ‚îî‚îÄ‚îÄ Home.module.css # Styles page d'accueil
‚îú‚îÄ‚îÄ test/               # Tests (unitaires, int√©gration)
‚îÇ   ‚îú‚îÄ‚îÄ lib/            # Tests des utilitaires
‚îÇ   ‚îú‚îÄ‚îÄ pages/          # Tests des pages/composants
‚îÇ   ‚îú‚îÄ‚îÄ integration/    # Tests d'int√©gration
‚îÇ   ‚îî‚îÄ‚îÄ setup.ts        # Configuration des tests
‚îî‚îÄ‚îÄ types/              # Types TypeScript
    ‚îî‚îÄ‚îÄ next-auth.d.ts  # Extensions NextAuth
```

### Configuration racine

```
‚îú‚îÄ‚îÄ .env.example        # Variables d'environnement exemple
‚îú‚îÄ‚îÄ .env.local          # Variables d'environnement locales (non versionn√©es)
‚îú‚îÄ‚îÄ .gitignore          # Fichiers ignor√©s par Git
‚îú‚îÄ‚îÄ docker-compose.yml  # Configuration PostgreSQL
‚îú‚îÄ‚îÄ eslint.config.mjs   # Configuration ESLint (Flat Config)
‚îú‚îÄ‚îÄ middleware.ts       # Middleware Next.js pour la protection des routes
‚îú‚îÄ‚îÄ next.config.ts      # Configuration Next.js
‚îú‚îÄ‚îÄ package.json        # D√©pendances et scripts
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma   # Sch√©ma de base de donn√©es
‚îÇ   ‚îî‚îÄ‚îÄ migrations/     # Migrations Prisma
‚îú‚îÄ‚îÄ tsconfig.json       # Configuration TypeScript
‚îú‚îÄ‚îÄ vitest.config.ts    # Configuration tests principaux
‚îî‚îÄ‚îÄ vitest.config.unit.ts # Configuration tests unitaires
```

### Sp√©cifications et impl√©mentation

Consultez les documents de sp√©cification dans `.kiro/specs/proconnect-authentication/` :

- `requirements.md` : Exigences fonctionnelles et cas d'usage
- `design.md` : Architecture technique et conception
- `tasks.md` : Plan d'impl√©mentation d√©taill√© (‚úÖ **Termin√©**)

**√âtat d'avancement** : L'authentification ProConnect est enti√®rement impl√©ment√©e et test√©e, incluant :

- ‚úÖ Configuration NextAuth.js avec provider ProConnect personnalis√©
- ‚úÖ V√©rification du statut d'agent public via `belonging_population`
- ‚úÖ Gestion des sessions s√©curis√©es avec timeout automatique
- ‚úÖ Middleware de protection des routes
- ‚úÖ Pages d'authentification et d'administration
- ‚úÖ Tests unitaires et d'int√©gration complets
- ‚úÖ Validation de configuration automatique
- ‚úÖ Gestion d'erreurs structur√©e

## ü§ù Contribution

Ce projet est destin√© √† l'administration fran√ßaise. Pour contribuer :

1. Forkez le projet
2. Cr√©ez une branche pour votre fonctionnalit√©
3. Committez vos changements
4. Poussez vers la branche
5. Ouvrez une Pull Request

## ÔøΩ L√âtat du projet

### Version actuelle : 0.1.0

**Derni√®res mises √† jour** :

- ‚úÖ **Configuration ProConnect mise √† jour** : Migration vers le nouveau domaine d'int√©gration `fca.integ01.dev-agentconnect.fr`
- ‚úÖ **Authentification ProConnect** : Impl√©mentation compl√®te avec provider OpenID Connect
- ‚úÖ **Validation de configuration** : Syst√®me de validation automatique au d√©marrage
- ‚úÖ **Tests complets** : Suite de tests unitaires, composants et int√©gration (Vitest)
- ‚úÖ **Interface DSFR** : Pages d'authentification et dashboard conformes au design system
- ‚úÖ **Middleware de s√©curit√©** : Protection automatique des routes selon le statut utilisateur
- ‚úÖ **Gestion d'erreurs** : Syst√®me d'erreurs structur√© avec logging et pages d√©di√©es

**Prochaines √©tapes** :

- üîÑ **Automatisations Grist** : D√©veloppement des outils d'automatisation
- üîÑ **API Grist** : Int√©gration avec l'API Grist pour la gestion des documents
- üîÑ **Workflows** : Syst√®me de workflows personnalisables
- üîÑ **Monitoring** : Tableau de bord de monitoring des automatisations

### Compatibilit√©

- **Node.js** : 18.0.0+ (test√© avec 18.x et 20.x)
- **Navigateurs** : Tous les navigateurs modernes support√©s par Next.js 15
- **Base de donn√©es** : PostgreSQL 15+ (compatible 13+)
- **ProConnect** : Environnements int√©gration et production
- **Docker** : Docker 20.0+ et Docker Compose 2.0+

## üéØ √âtat du projet

### Version actuelle : 0.1.0

**Derni√®res mises √† jour** :

- ‚úÖ **Configuration ProConnect mise √† jour** : Migration vers le nouveau domaine d'int√©gration `fca.integ01.dev-agentconnect.fr/api/v2`
- ‚úÖ **Authentification ProConnect** : Impl√©mentation compl√®te avec provider OpenID Connect
- ‚úÖ **Validation de configuration** : Syst√®me de validation automatique au d√©marrage
- ‚úÖ **Tests complets** : Suite de tests unitaires, composants et int√©gration (Vitest)
- ‚úÖ **Interface DSFR** : Pages d'authentification et dashboard conformes au design system
- ‚úÖ **Middleware de s√©curit√©** : Protection automatique des routes selon le statut utilisateur
- ‚úÖ **Gestion d'erreurs** : Syst√®me d'erreurs structur√© avec logging et pages d√©di√©es

**Prochaines √©tapes** :

- üîÑ **Automatisations Grist** : D√©veloppement des outils d'automatisation
- üîÑ **API Grist** : Int√©gration avec l'API Grist pour la gestion des documents
- üîÑ **Workflows** : Syst√®me de workflows personnalisables
- üîÑ **Monitoring** : Tableau de bord de monitoring des automatisations

### Compatibilit√©

- **Node.js** : 18.0.0+ (test√© avec 18.x et 20.x)
- **Navigateurs** : Tous les navigateurs modernes support√©s par Next.js 15
- **Base de donn√©es** : PostgreSQL 15+ (compatible 13+)
- **ProConnect** : Environnements int√©gration et production
- **Docker** : Docker 20.0+ et Docker Compose 2.0+

## üìÑ Licence

Ce projet est destin√© √† un usage interne de l'administration fran√ßaise.
